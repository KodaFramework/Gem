<html>
<head>
<link rel="stylesheet" href="/koda/css/editor.css" type="text/css" media="screen" title="no title" charset="utf-8">
<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<script src="/koda/scripts/plugins/json2.js" type="text/javascript" charset="utf-8"></script>
<script src="/koda/scripts/plugins/jquery.js" type="text/javascript" charset="utf-8"></script>
<script src="/koda/scripts/KodaEditor.js?987" type="text/javascript" charset="utf-8"></script>
</head>
<body>
	<div id="editor"></div>
<script>
	
	(function() {
		
		var api = Editor.Api;		
		var isNew = api.isNew;
		var url = PathHelper.getPath(api.itemUrl);
		
		api.get('/koda/koda-types/koda-json.js', function(kodaType) {
			
			var onLoad = function() {}
			
			var onUpdate = function(sdata){

				if(sdata == "OK") {					
					$('#status').text("item saved");									
				} else {				
					$('#status').text("item could not be saved");				
				}

			}

			var onSubmit = function(data) {				

				if(isNew) {
					
					var ref = data.name.replace(/ /g,"-").toLowerCase();
					data._koda_ref = ref;
					data.content = JSON.parse(data.content);
					var dataString = JSON.stringify(data, null, 2);
					api.post(url, dataString, onUpdate);

				} else {

					data.content = JSON.parse(data.content);
					var dataString = JSON.stringify(data, null, 2);
					api.put(url, dataString, onUpdate);

				}
			}

			var kodaForm = Editor.Form($('#editor'), kodaType, onSubmit);
			api.get(url, function(content){
				if(content != []) {
					kodaForm.registerConverter('content', function(value, control){
						control.setValue(JSON.stringify(value));
					});
					kodaForm.load(content);
				}
			});
			
		});

	})();
	
</script>
</body>
<html>
